<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeM Price Comparison - Modern E-Commerce</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load D3.js for Visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Custom styles for layout, fonts, and animation */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f6f8; /* Light gray background */
        }

        /* --- Custom Scrollbar for Category Bar --- */
        #categoryBar::-webkit-scrollbar {
            height: 6px;
        }

        #categoryBar::-webkit-scrollbar-thumb {
            background-color: #3b82f6;
            border-radius: 3px;
        }

        #categoryBar::-webkit-scrollbar-track {
            background: #e5e7eb;
        }

        /* --- Modal Backdrop & Animation --- */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
            transition: opacity 0.3s ease;
        }

        .modal-content {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* --- Product Specific Styles (Best Deal Highlight) --- */
        .best-deal-row {
            background-color: #eff6ff !important; /* Tailwind blue-50 for best deal row */
            font-weight: 600;
            border-left: 4px solid #3b82f6 !important; /* Primary blue marker */
        }

        .best-deal-row td {
            color: #1d4ed8; /* Darker blue text */
        }
        
        /* Ensure product cards are always block for filtering */
        .product-card {
            display: block;
        }

        /* D3 Chart Specific Styles */
        .bar {
            fill: #3b82f6; /* Blue */
            transition: fill 0.3s ease;
        }
        .bar.gem {
            fill: #10b981; /* Green for GeM */
        }
    </style>
</head>

<body class="min-h-screen">
    <!-- Load Icons -->
    <script>
        lucide.createIcons();
    </script>
    
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-blue-600 flex items-center">
                <i data-lucide="scan-eye" class="w-6 h-6 mr-2"></i> GeM Compare
            </h1>

            <!-- Search Bar -->
            <div class="hidden md:block flex-1 max-w-xl mx-8">
                <div class="relative">
                    <input type="text" id="searchBar" placeholder="Search for products, categories..." 
                           onkeyup="searchProduct()"
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                    >
                    <i data-lucide="search" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>

            <!-- User/Cart Buttons -->
            <div class="flex items-center space-x-4">
                <button onclick="toggleLogin()" class="flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition duration-150">
                    <i data-lucide="user" class="w-5 h-5 mr-1"></i> Login
                </button>
                <button onclick="toggleCart()" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition duration-150 relative">
                    <i data-lucide="shopping-cart" class="w-5 h-5 mr-1"></i> Cart
                    <span id="cartCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">0</span>
                </button>
            </div>
        </div>
        
        <!-- Category Bar -->
        <nav id="categoryBar" class="bg-gray-800 text-white overflow-x-auto whitespace-nowrap scroll-smooth py-2 shadow-inner">
            <div id="categoryContainer" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex space-x-6">
                <!-- Categories rendered here by JS -->
            </div>
        </nav>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- STATUS INDICATOR -->
        <div id="statusMessage" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-md" role="alert">
            <p class="font-bold">Dynamic Comparison Mode:</p>
            <p class="text-sm">Prices auto-refresh every 10 minutes to simulate market changes. Results are unbiased across all platforms.</p>
        </div>

        <!-- Product List (Top) -->
        <div id="productList" class="space-y-10">
            <!-- Product sections dynamically inserted here -->
        </div>

        <!-- DASHBOARD SECTION (Moved to the bottom) -->
        <div id="dashboard" class="bg-white p-6 rounded-xl shadow-lg mt-10 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="bar-chart-2" class="w-5 h-5 mr-2 text-blue-600"></i> Average Price Comparison by Platform
            </h2>
            <p class="text-sm text-gray-500 mb-4">This chart shows the current average price across all product categories for major platforms, offering a quick overview of overall savings potential.</p>
            <div id="priceChart" class="w-full overflow-x-auto">
                <!-- D3.js chart will be rendered here -->
            </div>
        </div>
    </main>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal-backdrop fixed inset-0 z-[100] hidden flex items-center justify-center">
        <div class="modal-content bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-semibold text-blue-600">Your Shopping Cart</h2>
                <button onclick="toggleCart()" class="text-gray-400 hover:text-gray-600 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="cartItems" class="max-h-80 overflow-y-auto space-y-3 py-2"></div>
            <div class="mt-6 pt-4 border-t-2 border-gray-200">
                <h3 class="text-xl font-bold flex justify-between items-center">
                    Total: <span class="text-green-600">₹<span id="cartTotal">0</span></span>
                </h3>
                <button onclick="checkout()" class="mt-4 w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                    Proceed to Checkout
                </button>
            </div>
        </div>
    </div>
    
    <!-- Login Modal -->
    <div id="loginModal" class="modal-backdrop fixed inset-0 z-[100] hidden flex items-center justify-center">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-blue-600">Login / Register</h2>
                <button onclick="toggleLogin()" class="text-gray-400 hover:text-gray-600 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form>
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="user@gov.in">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="••••••••">
                </div>
                <button type="button" onclick="handleLogin()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                    Login / Demo Access
                </button>
                <p class="text-sm text-center text-gray-500 mt-4">
                    Note: This is a static demo. Clicking login grants instant access.
                </p>
            </form>
        </div>
    </div>

    <!-- AI Insight Modal -->
    <div id="aiInsightModal" class="modal-backdrop fixed inset-0 z-[100] hidden flex items-center justify-center">
        <div class="modal-content bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-semibold text-blue-600 flex items-center">
                    <i data-lucide="sparkles" class="w-6 h-6 mr-2 text-yellow-500"></i> AI Product Insight
                </h2>
                <button onclick="document.getElementById('aiInsightModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <h3 id="aiInsightTitle" class="text-xl font-bold text-gray-800 mb-3">Product Name</h3>
            
            <!-- Insight Content -->
            <div id="aiInsightContent" class="bg-gray-50 p-4 rounded-lg text-gray-700 min-h-[150px]">
                <p id="insightText"></p>
                <p id="insightLoading" class="text-center text-gray-500 hidden mt-4">
                    <i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto"></i> Generating insight...
                </p>
            </div>

            <!-- Citations -->
            <div id="insightCitations" class="mt-4 pt-3 border-t text-xs text-gray-500">
                <p class="font-semibold mb-1">Sources (Simulated Grounding):</p>
                <ul id="citationList" class="list-disc list-inside space-y-1"></ul>
            </div>
        </div>
    </div>


    <script>
        // --- DATA SETUP & CONSTANTS ---
        const FIXED_INTERVAL_MS = 10 * 60 * 1000; // 10 minutes fixed refresh
        
        // Volatility Factors: Platforms known for sales (Amazon, Flipkart) get higher volatility, others are more stable.
        const VOLATILITY_FACTORS = {
            amazon: 0.05, // Up to 5% swing
            flipkart: 0.05, // Up to 5% swing
            croma: 0.02, // More stable, lower swing
            relianceDigital: 0.02,
            vijaySales: 0.02,
            myntra: 0.04,
            ajio: 0.04,
            decathlon: 0.01,
            gemPrice: 0.01 // GeM should be the most stable
        };
        const SALE_THRESHOLD = 0.95; // Price is considered a "Sale" if it drops below 95% of its baseline.

        const initialProducts = {
            "Electronics": [
                { "name": "Smart 4K TV (55in)", "linkSlug": "smart-tv-55", "image": "https://placehold.co/150x150/007bff/white?text=SMART+TV", "vijaySales": 72000, "croma": 71000, "relianceDigital": 70500, "amazon": 74000, "flipkart": 70000, "gemPrice": 68500 },
                { "name": "Refrigerator (260L, Double Door)", "linkSlug": "refrigerator-dd", "image": "https://placehold.co/150x150/007bff/white?text=FRIDGE", "vijaySales": 54579, "croma": 56299, "relianceDigital": 52560, "amazon": 67271, "flipkart": 49958, "gemPrice": 49358 },
                { "name": "Washing Machine (7kg, Fully Automatic)", "linkSlug": "washing-machine-7kg", "image": "https://placehold.co/150x150/007bff/white?text=WM", "vijaySales": 43699, "croma": 34651, "relianceDigital": 35712, "amazon": 33561, "flipkart": 29913, "gemPrice": 29313 },
                { "name": "Smartphone (256GB, Premium)", "linkSlug": "smartphone-premium", "image": "https://placehold.co/150x150/007bff/white?text=PHONE", "amazon": 85999, "flipkart": 84999, "relianceDigital": 86200, "croma": 88000, "gemPrice": 83800 },
                { "name": "Bluetooth Speaker (Portable)", "linkSlug": "bluetooth-speaker-p", "image": "https://placehold.co/150x150/007bff/white?text=SPEAKER", "vijaySales": 3499, "croma": 3599, "relianceDigital": 3399, "amazon": 3299, "flipkart": 3199, "gemPrice": 3099 },
                { "name": "Laptop (i7, 16GB RAM)", "linkSlug": "laptop-i7", "image": "https://placehold.co/150x150/007bff/white?text=LAPTOP", "amazon": 95000, "flipkart": 94500, "relianceDigital": 96000, "croma": 97500, "gemPrice": 93000 },
                { "name": "Microwave Oven (Convection)", "linkSlug": "microwave-conv", "image": "https://placehold.co/150x150/007bff/white?text=OVEN", "amazon": 15000, "flipkart": 14800, "croma": 15500, "gemPrice": 14500 },
                { "name": "Air Conditioner (1.5 Ton, Inverter)", "linkSlug": "ac-1.5t", "image": "https://placehold.co/150x150/007bff/white?text=A/C", "vijaySales": 38000, "croma": 37500, "relianceDigital": 39000, "flipkart": 37000, "gemPrice": 36500 },
                { "name": "Gaming Console (Latest Gen)", "linkSlug": "gaming-console", "image": "https://placehold.co/150x150/007bff/white?text=CONSOLE", "amazon": 52000, "flipkart": 51500, "relianceDigital": 53000, "gemPrice": 50500 },
                { "name": "DSLR Camera (Entry Level)", "linkSlug": "dslr-entry", "image": "https://placehold.co/150x150/007bff/white?text=CAMERA", "amazon": 42000, "flipkart": 41500, "croma": 42500, "relianceDigital": 43000, "gemPrice": 40500 },
                { "name": "Smart Watch (Fitness Focus)", "linkSlug": "smart-watch-fit", "image": "https://placehold.co/150x150/007bff/white?text=WATCH", "amazon": 18000, "flipkart": 17500, "croma": 18500, "gemPrice": 17000 },
                { "name": "Headphones (Noise Cancelling)", "linkSlug": "headphones-nc", "image": "https://placehold.co/150x150/007bff/white?text=HEADPHONES", "amazon": 22000, "flipkart": 21500, "relianceDigital": 22500, "gemPrice": 21000 }
            ],
            "Fashion": [
                { "name": "Men's T-Shirt (Cotton, Pkt)", "linkSlug": "mens-t-shirt-pkt", "image": "https://placehold.co/150x150/4f46e5/white?text=T-SHIRT", "amazon": 500, "flipkart": 450, "myntra": 400, "ajio": 425, "gemPrice": 350 },
                { "name": "Women's Kurti (Rayon, Floral)", "linkSlug": "womens-kurti-rayon", "image": "https://placehold.co/150x150/4f46e5/white?text=KURTI", "amazon": 700, "flipkart": 650, "myntra": 600, "ajio": 620, "gemPrice": 580 },
                { "name": "Men's Jeans (Slim Fit, Blue)", "linkSlug": "mens-jeans-slim", "image": "https://placehold.co/150x150/4f46e5/white?text=JEANS", "amazon": 1200, "flipkart": 1100, "myntra": 1150, "ajio": 1180, "gemPrice": 1050 },
                { "name": "Women's Saree (Silk Blend)", "linkSlug": "womens-saree-silk", "image": "https://placehold.co/150x150/4f46e5/white?text=SAREE", "amazon": 2500, "flipkart": 2400, "myntra": 2300, "ajio": 2450, "gemPrice": 2200 },
                { "name": "Unisex Hoodie (Fleece Lined)", "linkSlug": "unisex-hoodie-fl", "image": "https://placehold.co/150x150/4f46e5/white?text=HOODIE", "amazon": 800, "flipkart": 780, "myntra": 750, "ajio": 770, "gemPrice": 720 },
                { "name": "Men's Formal Shirt", "linkSlug": "mens-shirt-formal", "image": "https://placehold.co/150x150/4f46e5/white?text=SHIRT", "amazon": 1500, "flipkart": 1450, "myntra": 1400, "ajio": 1480, "gemPrice": 1350 },
                { "name": "Women's Leggings (Ankle Length)", "linkSlug": "womens-leggings-an", "image": "https://placehold.co/150x150/4f46e5/white?text=LEGGINGS", "amazon": 400, "flipkart": 380, "myntra": 350, "ajio": 390, "gemPrice": 320 },
                { "name": "Men's Leather Belt", "linkSlug": "mens-belt-leather", "image": "https://placehold.co/150x150/4f46e5/white?text=BELT", "amazon": 900, "flipkart": 850, "myntra": 880, "ajio": 920, "gemPrice": 800 },
                { "name": "Women's Handbag (Tote)", "linkSlug": "womens-handbag-tote", "image": "https://placehold.co/150x150/4f46e5/white?text=HANDBAG", "amazon": 3000, "flipkart": 2950, "myntra": 3100, "ajio": 3050, "gemPrice": 2800 },
                { "name": "Sneakers (Unisex, Sports)", "linkSlug": "sneakers-sports", "image": "https://placehold.co/150x150/4f46e5/white?text=SHOES", "amazon": 2800, "flipkart": 2750, "myntra": 2900, "ajio": 2850, "gemPrice": 2600 }
            ],
            "Accessories": [
                { "name": "Smart Watch (Classic)", "linkSlug": "smart-watch-classic", "image": "https://placehold.co/150x150/f97316/white?text=WATCH", "amazon": 3000, "flipkart": 2900, "croma": 3200, "myntra": 3150, "gemPrice": 2800 },
                { "name": "Leather Wallet (Bi-Fold)", "linkSlug": "leather-wallet-bi", "image": "https://placehold.co/150x150/f97316/white?text=WALLET", "amazon": 800, "flipkart": 750, "myntra": 720, "croma": 850, "gemPrice": 700 },
                { "name": "Backpack (Laptop Comp. 15in)", "linkSlug": "backpack-15", "image": "https://placehold.co/150x150/f97316/white?text=BAG", "amazon": 1200, "flipkart": 1150, "croma": 1250, "myntra": 1180, "gemPrice": 1100 },
                { "name": "Bluetooth Earbuds (ANC)", "linkSlug": "earbuds-anc", "image": "https://placehold.co/150x150/f97316/white?text=EARBUDS", "amazon": 4500, "flipkart": 4400, "croma": 4600, "myntra": 4350, "gemPrice": 4200 },
                { "name": "Power Bank (10000 mAh)", "linkSlug": "power-bank-10k", "image": "https://placehold.co/150x150/f97316/white?text=POWER", "amazon": 1500, "flipkart": 1450, "relianceDigital": 1550, "croma": 1600, "gemPrice": 1350 },
                { "name": "Sunglasses (UV Protect)", "linkSlug": "sunglasses-uv", "image": "https://placehold.co/150x150/f97316/white?text=SUNGLASSES", "amazon": 700, "flipkart": 650, "myntra": 600, "ajio": 620, "gemPrice": 550 },
                { "name": "USB Drive (128GB)", "linkSlug": "usb-128gb", "image": "https://placehold.co/150x150/f97316/white?text=USB", "amazon": 1100, "flipkart": 1050, "relianceDigital": 1150, "croma": 1200, "gemPrice": 1000 },
                { "name": "Travel Adapter (Universal)", "linkSlug": "adapter-uni", "image": "https://placehold.co/150x150/f97316/white?text=ADAPTER", "amazon": 550, "flipkart": 500, "croma": 580, "gemPrice": 480 },
                { "name": "Laptop Sleeve (14 inch)", "linkSlug": "sleeve-14", "image": "https://placehold.co/150x150/f97316/white?text=SLEEVE", "amazon": 650, "flipkart": 600, "myntra": 620, "gemPrice": 550 },
                { "name": "Tripod (Phone/Camera)", "linkSlug": "tripod-phcam", "image": "https://placehold.co/150x150/f97316/white?text=TRIPOD", "amazon": 1800, "flipkart": 1750, "croma": 1850, "gemPrice": 1650 }
            ],
            "Home & Kitchen": [
                { "name": "Microwave Oven (20L)", "linkSlug": "microwave-20l", "image": "https://placehold.co/150x150/10b981/white?text=MICROWAVE", "amazon": 6000, "flipkart": 5900, "croma": 6100, "relianceDigital": 6200, "gemPrice": 5800 },
                { "name": "Air Purifier (HEPA)", "linkSlug": "air-purifier-hepa", "image": "https://placehold.co/150x150/10b981/white?text=PURIFIER", "amazon": 9000, "flipkart": 8700, "croma": 8900, "relianceDigital": 9100, "gemPrice": 8500 },
                { "name": "Vacuum Cleaner (Robotic)", "linkSlug": "vacuum-robotic", "image": "https://placehold.co/150x150/10b981/white?text=VACUUM", "amazon": 25000, "flipkart": 24500, "croma": 25500, "relianceDigital": 26000, "gemPrice": 24000 },
                { "name": "Induction Cooktop (2000W)", "linkSlug": "cooktop-2000w", "image": "https://placehold.co/150x150/10b981/white?text=COOKTOP", "amazon": 2500, "flipkart": 2400, "croma": 2600, "relianceDigital": 2700, "gemPrice": 2300 },
                { "name": "Water Purifier (RO+UV)", "linkSlug": "water-purifier-ro", "image": "https://placehold.co/150x150/10b981/white?text=WATER+FILTER", "amazon": 12000, "flipkart": 11800, "croma": 12200, "relianceDigital": 12500, "gemPrice": 11500 },
                { "name": "Coffee Maker (Automatic)", "linkSlug": "coffee-maker-auto", "image": "https://placehold.co/150x150/10b981/white?text=COFFEE", "amazon": 5000, "flipkart": 4900, "croma": 5100, "relianceDigital": 5200, "gemPrice": 4800 },
                { "name": "Hand Blender (Electric)", "linkSlug": "hand-blender-elec", "image": "https://placehold.co/150x150/10b981/white?text=BLENDER", "amazon": 1800, "flipkart": 1750, "croma": 1850, "relianceDigital": 1900, "gemPrice": 1700 },
                { "name": "Non-Stick Cookware Set (5 pc)", "linkSlug": "cookware-5pc", "image": "https://placehold.co/150x150/10b981/white?text=COOKWARE", "amazon": 3500, "flipkart": 3400, "croma": 3600, "relianceDigital": 3700, "gemPrice": 3300 },
                { "name": "LED Desk Lamp (Dimmable)", "linkSlug": "desk-lamp-led", "image": "https://placehold.co/150x150/10b981/white?text=LAMP", "amazon": 950, "flipkart": 900, "relianceDigital": 980, "gemPrice": 850 },
                { "name": "Storage Container Set (Airtight)", "linkSlug": "storage-container-s", "image": "https://placehold.co/150x150/10b981/white?text=STORAGE", "amazon": 1200, "flipkart": 1150, "myntra": 1250, "gemPrice": 1050 }
            ],
            "Sports": [ // Keeping 5 for simplicity as this is a minor category in the list
                { "name": "Cricket Bat (Kashmir Willow)", "linkSlug": "cricket-bat-kw", "image": "https://placehold.co/150x150/34d399/white?text=BAT", "amazon": 1500, "flipkart": 1400, "decathlon": 1350, "gemPrice": 1300 },
                { "name": "Football (Size 5, PU)", "linkSlug": "football-s5", "image": "https://placehold.co/150x150/34d399/white?text=FOOTBALL", "amazon": 700, "flipkart": 650, "decathlon": 600, "gemPrice": 590 },
                { "name": "Yoga Mat (TPE, 6mm)", "linkSlug": "yoga-mat-6mm", "image": "https://placehold.co/150x150/34d399/white?text=YOGA", "amazon": 500, "flipkart": 480, "decathlon": 450, "gemPrice": 430 },
                { "name": "Tennis Racket (Intermediate)", "linkSlug": "tennis-racket-int", "image": "https://placehold.co/150x150/34d399/white?text=RACKET", "amazon": 2000, "flipkart": 1900, "decathlon": 1850, "gemPrice": 1800 },
                { "name": "Skipping Rope (Weighted)", "linkSlug": "skipping-rope-w", "image": "https://placehold.co/150x150/34d399/white?text=ROPE", "amazon": 150, "flipkart": 140, "decathlon": 130, "gemPrice": 120 }
            ]
        };

        // Combine all products into an internal "All Products" list for search/average calculations
        const allProductsList = Object.keys(initialProducts).flatMap(cat => initialProducts[cat]);
        initialProducts["All Products"] = allProductsList;


        let products = JSON.parse(JSON.stringify(initialProducts)); // Current dynamic prices
        let cart = [];
        let currentCategory = "Home"; // Default view is now the Home/Landing Page
        let platformKeys = []; 

        // --- UTILITY FUNCTIONS ---

        function getIconForCategory(category) {
            switch (category) {
                case "Home": return "home";
                case "Electronics": return "laptop";
                case "Fashion": return "shirt";
                case "Accessories": return "watch";
                case "Home & Kitchen": return "blender";
                case "Sports": return "dumbbell";
                default: return "layout-list";
            }
        }

        function formatPrice(price) {
            // Ensure price is a number and finite before formatting
            if (typeof price === 'number' && isFinite(price)) {
                return price.toLocaleString('en-IN');
            }
            return 'N/A';
        }
        
        function getPlatformDisplayName(platformKey) {
            if (platformKey === 'gemPrice') {
                return 'GeM Price';
            }
            // Logic to convert keys like 'relianceDigital' to 'Reliance Digital'
            return platformKey.replace(/([a-z])([A-Z])/g, '$1 $2')
                                .split(' ')
                                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                                .join(' ');
        }
        
        function getSearchLink(productName, platformKey) {
            const platformName = platformKey.replace('Price', '');
            let domain = '';
            
            switch (platformName) {
                case 'amazon': domain = 'amazon.in'; break;
                case 'flipkart': domain = 'flipkart.com'; break;
                case 'croma': domain = 'croma.com'; break;
                case 'relianceDigital': domain = 'reliancedigital.in'; break;
                case 'myntra': domain = 'myntra.com'; break;
                case 'ajio': domain = 'ajio.com'; break;
                case 'vijaySales': domain = 'vijaysales.com'; break;
                case 'decathlon': domain = 'decathlon.in'; break;
                case 'gem': domain = 'gem.gov.in'; break;
                default: domain = 'google.com';
            }
            
            const query = encodeURIComponent(`${productName} price on ${domain}`);
            return `https://www.google.com/search?q=${query}`;
        }


        // --- DASHBOARD DATA PROCESSING ---
        function calculateAveragePrices() {
            const platformTotals = {};
            const platformCounts = {};
            
            // CRITICAL FIX: Ensure platformKeys is correctly derived from the initial, full dataset
            // Find a sample product with all keys present
            const sampleProduct = initialProducts["Electronics"][0] || {};
            platformKeys = Object.keys(sampleProduct).filter(key => 
                !['name', 'linkSlug', 'image'].includes(key)
            );

            Object.keys(products).filter(cat => cat !== "All Products" && cat !== "Home").forEach(category => {
                products[category].forEach(product => {
                    platformKeys.forEach(platform => {
                        const price = product[platform];
                        if (typeof price === 'number' && isFinite(price)) {
                            platformTotals[platform] = (platformTotals[platform] || 0) + price;
                            platformCounts[platform] = (platformCounts[platform] || 0) + 1;
                        }
                    });
                });
            });

            const averagePrices = platformKeys.map(platform => ({
                platform: getPlatformDisplayName(platform),
                average: platformCounts[platform] > 0 ? platformTotals[platform] / platformCounts[platform] : 0,
                isGem: platform === 'gemPrice'
            }));

            averagePrices.sort((a, b) => a.average - b.average);

            return averagePrices;
        }

        // --- DASHBOARD RENDERING (D3.js) ---
        function renderDashboard(data) {
            const dashboardContainer = document.getElementById('dashboard');
            
            // Only show dashboard if a category is selected (not Home)
            if (currentCategory === "Home") {
                dashboardContainer.classList.add('hidden');
                return;
            }
            
            dashboardContainer.classList.remove('hidden');
            
            const chartDiv = d3.select("#priceChart");
            chartDiv.html(""); // Clear previous chart
            
            const margin = { top: 20, right: 20, bottom: 60, left: 80 };
            const chartContainerWidth = document.getElementById('dashboard').clientWidth - margin.left - margin.right;
            const width = Math.max(500, chartContainerWidth);
            const height = 300 - margin.top - margin.bottom;

            // D3 chart rendering logic (omitted for brevity, assume correct rendering as per previous steps)
            // ... (The D3 logic remains the same as the prior version, utilizing the updated data structure)
            
            const svg = chartDiv.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand().domain(data.map(d => d.platform)).range([0, width]).padding(0.3);
            const y = d3.scaleLinear().domain([0, d3.max(data, d => d.average) * 1.1]).range([height, 0]);

            svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x)).selectAll("text").style("text-anchor", "middle").attr("dy", ".8em");
            svg.append("g").call(d3.axisLeft(y).tickFormat(d => `₹${formatPrice(d)}`));

            const bars = svg.selectAll(".bar")
                .data(data)
                .join("rect")
                .attr("class", d => d.isGem ? "bar gem" : "bar")
                .attr("x", d => x(d.platform))
                .attr("width", x.bandwidth())
                .attr("y", height)
                .attr("height", 0)
                .on("mouseover", function(event, d) {
                    d3.select(this).style("fill", "#ff9800"); 
                    const tooltipGroup = svg.append("g").attr("class", "tooltip-group").attr("transform", `translate(${x(d.platform) + x.bandwidth() / 2}, ${y(d.average) - 15})`);
                    const priceText = `₹${formatPrice(d.average)}`;
                    tooltipGroup.append("rect").attr("x", -50).attr("y", -25).attr("width", 100).attr("height", 25).attr("rx", 4).attr("fill", "#333").attr("opacity", 0.9);
                    tooltipGroup.append("text").attr("text-anchor", "middle").attr("y", -8).attr("font-size", "12px").attr("fill", "white").attr("font-weight", "bold").text(priceText);
                })
                .on("mouseout", function(event, d) {
                    d3.select(this).style("fill", d.isGem ? "#10b981" : "#3b82f6");
                    d3.selectAll(".tooltip-group").remove(); 
                });

            bars.transition().duration(700).attr("y", d => y(d.average)).attr("height", d => height - y(d.average));
            svg.append("text").attr("transform", "rotate(-90)").attr("y", 0 - margin.left).attr("x", 0 - (height / 2)).attr("dy", "1em").style("text-anchor", "middle").text("Average Price (INR)");
        }


        // --- PRICE ADJUSTMENT (Dynamic Demo) ---

        function adjustPrices() {
            const baseProducts = JSON.parse(JSON.stringify(initialProducts));
            
            // Unbiased price adjustment across all categories and platforms
            Object.keys(baseProducts).filter(cat => cat !== "All Products").forEach(category => {
                // Pre-calculate a map of original products for fast lookup
                const originalProductMap = new Map(initialProducts[category].map(p => [p.name, p]));
                
                baseProducts[category].forEach(product => {
                    // Look up the original product using its unique name
                    const originalProduct = originalProductMap.get(product.name);
                    
                    for (const platform in product) {
                        
                        // Check if the platform key corresponds to a numeric price
                        if (originalProduct && typeof originalProduct[platform] === 'number') {
                            const basePrice = originalProduct[platform];
                            const platformKey = platform.replace('Price', ''); 
                            const volatility = VOLATILITY_FACTORS[platformKey] * basePrice;
                            
                            // Generate random change within platform's volatility range
                            const randomChange = (Math.random() * volatility * 2) - volatility; 
                            let newPrice = Math.max(1, Math.round(basePrice + randomChange));
                            
                            // Final validation: Ensure we only assign a valid number
                            if (typeof newPrice === 'number' && isFinite(newPrice)) {
                                product[platform] = newPrice;
                            } else {
                                // Fallback to original price if calculation failed (prevents NaN/N/A)
                                product[platform] = basePrice;
                            }

                        } else if (product.hasOwnProperty(platform) && platform !== 'name' && platform !== 'image' && platform !== 'linkSlug') {
                            // Non-numeric fields (e.g., name, image) carry through, or handle keys that might be unexpectedly undefined.
                            // If a price key exists but is not numeric in the original data, keep the value (though this shouldn't happen).
                            product[platform] = product[platform]; 
                        }
                    }
                });
                
                products[category] = baseProducts[category];
            });
            
            // Re-generate the combined list
            products["All Products"] = Object.keys(products).filter(cat => cat !== "All Products").flatMap(cat => products[cat]);

            displayProducts(currentCategory);
            renderDashboard(calculateAveragePrices());
        }
        
        // --- SCHEDULE UPDATE FUNCTION ---
        function scheduleNextPriceUpdate() {
            // Changed to a fixed interval of 10 minutes
            setInterval(() => {
                adjustPrices();
            }, FIXED_INTERVAL_MS);
        }
        
        // --- DISPLAY & RENDERING ---
        
        function setCategory(category) {
            currentCategory = category;
            displayProducts(category);
            highlightCategoryButton(category);
            
            document.getElementById('searchBar').value = ''; 
        }

        function highlightCategoryButton(activeCategory) {
            const buttons = document.querySelectorAll('#categoryContainer button');
            buttons.forEach(button => {
                if (button.dataset.category === activeCategory) {
                    button.classList.add('bg-blue-600', 'text-white');
                    button.classList.remove('bg-gray-700', 'text-gray-300');
                } else {
                    button.classList.remove('bg-blue-600', 'text-white');
                    button.classList.add('bg-gray-700', 'text-gray-300');
                }
            });
        }
        
        function renderCategoryBar() {
            const container = document.getElementById('categoryContainer');
            container.innerHTML = '';
            
            // Manual list including "Home"
            const categories = ["Home", ...Object.keys(initialProducts).filter(cat => cat !== "All Products")];

            categories.forEach(category => {
                const icon = getIconForCategory(category);
                const button = document.createElement('button');
                button.dataset.category = category;
                button.className = 'flex items-center px-4 py-2 rounded-lg font-medium whitespace-nowrap transition duration-150 text-sm';
                button.setAttribute('onclick', `setCategory('${category}')`);
                button.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 mr-2"></i> ${category}`;
                container.appendChild(button);
            });
            
            lucide.createIcons();
            highlightCategoryButton(currentCategory);
        }

        function renderHomePageContent() {
            const productList = document.getElementById('productList');
            productList.classList.remove('grid', 'grid-cols-2', 'md:grid-cols-4', 'lg:grid-cols-5', 'gap-6');
            productList.classList.add('space-y-10');

            // --- HERO SECTION ---
            const hero = `
                <div class="bg-blue-600 text-white rounded-xl shadow-xl p-10 md:p-16 text-center mb-10">
                    <h2 class="text-4xl md:text-5xl font-extrabold mb-4 tracking-tight">
                        Government Efficiency, Private Savings.
                    </h2>
                    <p class="text-xl opacity-90 mb-6 max-w-3xl mx-auto">
                        Instantly compare prices across all major e-commerce platforms against the GeM price to ensure maximum value for every purchase.
                    </p>
                    <button onclick="setCategory('Electronics')" class="bg-yellow-400 text-gray-900 px-8 py-3 rounded-full text-lg font-bold hover:bg-yellow-300 transition shadow-lg">
                        Start Comparing Now <i data-lucide="chevrons-right" class="w-5 h-5 ml-2 inline"></i>
                    </button>
                </div>
            `;
            
            // --- ABOUT GEM SECTION ---
            const aboutGem = `
                <div class="bg-white p-6 md:p-10 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        <i data-lucide="info" class="w-5 h-5 mr-2 text-green-500"></i> What is GeM (Government e-Marketplace)?
                    </h3>
                    <p class="text-gray-600 mb-4">
                        GeM is the national public procurement portal of India for the purchase of goods and services required by Central and State Government organizations. It promotes transparency, efficiency, and speed in the public procurement process. Our platform helps you visualize how GeM's prices compare against the open market.
                    </p>
                </div>
            `;

            // --- CATEGORY TILES ---
            const categoriesToDisplay = Object.keys(initialProducts).filter(cat => cat !== "All Products");
            const categoryTiles = `
                <div class="pt-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Browse Top Categories</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-6">
                        ${categoriesToDisplay.map(cat => `
                            <div onclick="setCategory('${cat}')" class="bg-white p-6 rounded-xl shadow-md hover:shadow-xl hover:scale-[1.02] transition duration-300 cursor-pointer text-center border-t-4 border-blue-500 flex flex-col items-center">
                                <i data-lucide="${getIconForCategory(cat)}" class="w-8 h-8 text-blue-600 mb-3"></i>
                                <p class="font-semibold text-gray-800">${cat}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            productList.innerHTML = hero + aboutGem + categoryTiles;
            lucide.createIcons();
            document.getElementById('dashboard').classList.add('hidden');
        }

        
        // --- CORE DISPLAY FUNCTION ---
        function displayProducts(categoryFilter = "Home") {
            const productList = document.getElementById('productList');
            productList.innerHTML = '';
            
            if (categoryFilter === "Home") {
                renderHomePageContent();
                return;
            }

            const productsToDisplay = products[categoryFilter];
            const currentTime = new Date().toLocaleTimeString();

            // --- DETAILED COMPARISON VIEW FOR SPECIFIC CATEGORY (SHOW ALL PLATFORMS) ---
            productList.classList.add('space-y-10');
            productList.classList.remove('grid', 'grid-cols-2', 'md:grid-cols-4', 'lg:grid-cols-5', 'gap-6');

            productsToDisplay.forEach(product => {
                // 1. Get all price entries, including GeM Price
                let allPlatformPrices = Object.entries(product)
                    // CRITICAL FIX: Ensure value is a number before mapping. This prevents NaN/N/A issues.
                    .filter(([key, value]) => typeof value === 'number')
                    .map(([platform, price]) => ({
                        platform,
                        price,
                        link: getSearchLink(product.name, platform)
                    }));
                
                // 2. Sort prices ascending (Lowest price at the top)
                allPlatformPrices.sort((a, b) => a.price - b.price);

                // Find the true lowest price
                const lowestPrice = allPlatformPrices.length > 0 ? allPlatformPrices[0].price : 0;
                const isGemLowest = allPlatformPrices.length > 0 && allPlatformPrices[0].platform === 'gemPrice';

                const productCardHTML = `
                    <div class="product-card bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 border ${isGemLowest ? 'border-blue-300' : 'border-gray-200'}">
                        
                        <div class="flex flex-col md:flex-row items-center md:items-start space-y-4 md:space-y-0 md:space-x-6">
                            
                            <!-- Product Image & Info -->
                            <div class="w-24 h-24 flex-shrink-0 border-2 border-gray-100 rounded-lg overflow-hidden flex items-center justify-center">
                                <img src="${product.image}" alt="${product.name}" class="w-full h-full object-contain">
                            </div>

                            <div class="flex-grow">
                                <h3 class="text-xl font-bold text-gray-800 flex justify-between items-center">
                                    ${product.name}
                                    <button onclick="generateAIInsight('${product.name}', '${JSON.stringify(allPlatformPrices.map(({ platform, price }) => ({ platform, price }))).replace(/"/g, '&quot;')}')" 
                                        class="px-3 py-1 bg-yellow-400 text-gray-800 text-sm rounded-full hover:bg-yellow-500 transition duration-150 flex items-center">
                                        <i data-lucide="sparkles" class="w-4 h-4 mr-1"></i> Get AI Insight
                                    </button>
                                </h3>
                                <p class="text-sm text-gray-500 mb-2">Category: ${categoryFilter}</p>
                                <p class="text-2xl font-extrabold ${isGemLowest ? 'text-blue-600' : 'text-red-500'}">
                                    Lowest Price: ₹${formatPrice(lowestPrice)} ${isGemLowest ? ' (GeM Deal!)' : ''}
                                </p>
                                <p class="text-xs text-gray-400 mt-1">Prices last adjusted: ${currentTime}</p>
                            </div>
                        </div>
                        
                        <!-- Price Comparison Table (Show ALL Platforms) -->
                        <div class="mt-6 border-t pt-4">
                            <h4 class="text-lg font-semibold text-gray-700 mb-3">Full Price Comparison (All Platforms):</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Platform</th>
                                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">View Link</th>
                                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${allPlatformPrices.map(item => {
                                            const rowClass = item.price === lowestPrice ? 'best-deal-row' : 'hover:bg-gray-50';
                                            const platformName = getPlatformDisplayName(item.platform);
                                            
                                            // Check for sale status for the table
                                            const originalProduct = initialProducts[categoryFilter].find(p => p.name === product.name);
                                            // Ensure originalPrice is a number before comparison
                                            const originalPrice = originalProduct ? (typeof originalProduct[item.platform] === 'number' ? originalProduct[item.platform] : item.price) : item.price;
                                            const isSale = item.price < originalPrice * SALE_THRESHOLD;
                                            
                                            const saleTag = isSale ? `<span class="bg-red-100 text-red-600 font-bold px-1.5 py-0.5 rounded-full text-xs">Deal!</span>` : '';
                                            
                                            return `
                                                <tr class="${rowClass}">
                                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${platformName}</td>
                                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-900">
                                                        <div class="flex flex-col items-center">
                                                            ₹${formatPrice(item.price)} ${item.price === lowestPrice ? '⭐' : ''}
                                                            ${saleTag}
                                                        </div>
                                                    </td>
                                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                                                        <a href="${item.link}" target="_blank" class="text-blue-500 hover:text-blue-700 font-medium">Go to Site</a>
                                                    </td>
                                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                                                        <button onclick="addToCart('${product.name} (${item.platform})', ${item.price})" 
                                                                class="px-3 py-1 bg-green-500 text-white text-xs rounded-full hover:bg-green-600 transition">
                                                            Add to Cart
                                                        </button>
                                                    </td>
                                                </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                productList.innerHTML += productCardHTML;
            });
            lucide.createIcons(); // Re-render new icons
        }
        
        // --- LLM GENERATION FUNCTION (Unchanged) ---
        async function generateAIInsight(productName, platformPricesJson) {
            const insightModal = document.getElementById('aiInsightModal');
            const insightTitle = document.getElementById('aiInsightTitle');
            const insightText = document.getElementById('insightText');
            const citationList = document.getElementById('citationList');
            const insightLoading = document.getElementById('insightLoading');

            // CRITICAL FIX: Parse the JSON string passed from the onclick attribute
            let platformPrices;
            try {
                // Replace HTML entity for double quote back to double quote for JSON parsing
                platformPrices = JSON.parse(platformPricesJson.replace(/&quot;/g, '"'));
            } catch (e) {
                console.error("Error parsing platformPrices JSON:", e);
                insightText.innerHTML = '<p class="text-red-600">Error: Failed to parse price data for AI analysis.</p>';
                insightLoading.classList.add('hidden');
                insightModal.classList.remove('hidden');
                return;
            }

            // 1. Setup UI
            insightTitle.textContent = `${productName} Analysis`;
            insightText.textContent = '';
            citationList.innerHTML = '';
            insightLoading.classList.remove('hidden');
            insightModal.classList.remove('hidden');
            lucide.createIcons();
            
            // 2. Setup API Call details (Unchanged)
            const systemPrompt = "You are a specialized E-commerce Product Analyst for a price comparison service. Analyze the product and the provided price comparison data. Generate a concise (max 3 sentences) summary focused on 1) the product's main appeal (based on product name, using Google Search to enrich description) and 2) the significance of the current pricing structure (mentioning the lowest price platform and the average competitor price).";
            const competitorPrices = platformPrices.filter(p => p.platform !== 'gemPrice');
            const pricesSum = competitorPrices.reduce((sum, p) => sum + p.price, 0);
            const avgPrice = competitorPrices.length > 0 ? pricesSum / competitorPrices.length : 0;
            
            const formattedPrices = platformPrices.map(p => `${getPlatformDisplayName(p.platform)}: ₹${formatPrice(p.price)}`).join(', ');

            const userQuery = `Product: ${productName}. Current Prices: ${formattedPrices}. Average Competitor Price: ₹${formatPrice(avgPrice)}. Please generate the analysis.`;
            
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            let responseData;
            let attempts = 0;
            const maxAttempts = 3;
            const initialDelay = 1000;

            // 3. API Call with Exponential Backoff (Unchanged)
            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    responseData = await response.json();
                    
                    if (response.ok) {
                        break; // Success
                    } else if (response.status === 429) {
                        attempts++;
                        const delay = initialDelay * Math.pow(2, attempts - 1);
                        if (attempts < maxAttempts) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            throw new Error("API rate limit exceeded after multiple retries.");
                        }
                    } else {
                        throw new Error(`API error: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error("Fetch failed:", error);
                    if (attempts === maxAttempts) {
                        insightText.innerHTML = `<p class="text-red-600">Error: Failed to fetch AI insight. Please try again later. (${error.message})</p>`;
                        insightLoading.classList.add('hidden');
                        return;
                    }
                    attempts++;
                }
            }

            // 4. Process Response (Unchanged)
            insightLoading.classList.add('hidden');
            const candidate = responseData?.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                insightText.textContent = candidate.content.parts[0].text;

                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && candidate.groundingMetadata.groundingAttributions) {
                    const sources = candidate.groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);

                    if (sources.length > 0) {
                        citationList.innerHTML = sources.map(source => 
                            `<li><a href="${source.uri}" target="_blank" class="text-blue-500 hover:underline">${source.title.substring(0, 50)}...</a></li>`
                        ).join('');
                    } else {
                        citationList.innerHTML = '<li>No specific external web sources were used for grounding this general analysis.</li>';
                    }
                }
            } else {
                insightText.innerHTML = '<p class="text-red-600">Error: Could not generate a valid insight summary.</p>';
            }
        }


        // --- INTERACTION FUNCTIONS (Cart, Login, Search) ---

        function addToCart(name, price) {
            cart.push({ name, price });
            updateCart();
        }

        function updateCart() {
            const cartCount = document.getElementById('cartCount');
            cartCount.innerText = cart.length;
            const cartItems = document.getElementById('cartItems');
            const total = cart.reduce((t, item) => t + item.price, 0);

            if (cart.length === 0) {
                cartItems.innerHTML = "<p class='text-center text-gray-500'>Your cart is empty.</p>";
            } else {
                cartItems.innerHTML = cart.map(item => 
                    `<div class="flex justify-between items-center text-sm border-b border-gray-100 last:border-b-0 py-2">
                        <span class="text-gray-700">${item.name.substring(0, 40) + (item.name.length > 40 ? '...' : '')}</span> 
                        <span class="font-medium text-gray-900">₹${formatPrice(item.price)}</span>
                    </div>`
                ).join('');
            }

            document.getElementById('cartTotal').innerText = formatPrice(total);
        }

        function toggleCart() {
            const modal = document.getElementById('cartModal');
            modal.classList.toggle('hidden');
        }

        function checkout() {
            const total = cart.reduce((t, item) => t + item.price, 0);
            if (cart.length > 0) {
                alert(`SUCCESS: Checkout initiated! Total amount: ₹${formatPrice(total)}. (This is a demonstration checkout)`);
                cart = []; 
                updateCart();
                toggleCart();
            } else {
                alert("Please add items to your cart before checking out.");
            }
        }
        
        function toggleLogin() {
            const modal = document.getElementById('loginModal');
            modal.classList.toggle('hidden');
        }
        
        function handleLogin() {
            alert("SUCCESS: Demo access granted! Welcome to GeM Compare.");
            toggleLogin();
        }


        function searchProduct() {
            const input = document.getElementById('searchBar');
            const filter = input.value.toUpperCase();
            
            // If currently on Home, switch to the detailed product grid view for searching
            if (currentCategory === "Home") {
                 // Temporarily set category to a generic one to activate product list rendering for search
                setCategory("Electronics"); // Fallback to first category to render products
            }
            
            // Wait for displayProducts to re-render the grid before filtering
            setTimeout(() => {
                const allProducts = document.querySelectorAll('.product-card');

                allProducts.forEach(product => {
                    // Check if we are in the detailed view or the simple grid view
                    const productNameElement = product.querySelector('h3');
                    if (productNameElement) {
                        const productName = productNameElement.innerText.toUpperCase();
                         if (productName.includes(filter)) {
                            product.style.display = "block";
                        } else {
                            product.style.display = "none";
                        }
                    } else {
                         // If on the Home screen, search should do nothing to the product list (which is hidden)
                        product.style.display = "none";
                    }
                });
            }, 50); 
        }

        // --- INITIALIZATION ---

        window.onload = function() {
            renderCategoryBar();
            // Call adjustPrices first to populate the `products` object with initial values
            adjustPrices(); 
            updateCart();
            
            // Start the fixed 10-minute price update schedule
            scheduleNextPriceUpdate(); 
            // Set initial view to Home page
            setCategory("Home");
        }
    </script>
</body>
</html>